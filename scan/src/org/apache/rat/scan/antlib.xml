<?xml version="1.0"?>
<!--
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
  http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<antlib xmlns:current="ant:current">
    
    <macrodef 
        name='AuditSetup'
        description='Common preparation for audit'>
        <attribute 
            name='stem' 
            default='rat-scan'
            description='File name prefix'/>
        <sequential>
          <tstamp>
              <format property="org.apache.rat.scan.ISO_TODAY" pattern="yyyy-MM-dd" locale="en,GMT"/>
          </tstamp>
          <property name='org.apache.rat.scan.name.data' value='@{stem}-data-${org.apache.rat.scan.ISO_TODAY}.xml'/>
          <property name='org.apache.rat.scan.name.diff' value='@{stem}-diff-${org.apache.rat.scan.ISO_TODAY}.xml'/>
        
        </sequential>
    </macrodef>
    
    <macrodef
        name='DoAudit' 
        description='Connects to people.apache.org and audits incubator releases'>
        <attribute 
            name='src-dir'
            description='Directory containing rat scan source'/>
        <attribute 
            name='result-dir'
            description='Directory to store outputs'/>
        <attribute 
            name='host'
            description='SSH host address'/>
        <attribute 
            name='stem' 
            default='rat-scan'
            description='File name prefix'/>
        <sequential>
            <echo>
Audit pipes a python script to people.apache.org.
The connection is made over ssh to alias named apache.
Configure ssh appropriately.
Before running, add a key to the agent.
            </echo>
            <echo>
GnuPG is used to create digital signatures of the audit
records. These allow the records to be trusted
without the need to trust that the repository 
is secure. gpg must be on the PATH.
This script has been tested using gpg (GnuPG) 2.0.7
            </echo>
            <echo>
A signed copy of the results will be posted to the 
incubator general list if mail is available.
Copy EXAMPLE.mail.properties to mail.properties
then edit.
            </echo>
            <echo>
Until someone steps up with a port, 
this script is unlikely to work on windows
(or - for that matter - AmigaOS, CPM...)
            </echo>
            <echo>
Auditing may take a few minutes. Time for a tea...
            </echo>
            
            <current:AuditSetup/>
            <exec executable="python">
                <arg path='@{src-dir}/org/apache/rat/scan/connect.py'/>
                <arg path='@{result-dir}'/>
                <arg value='${org.apache.rat.scan.name.data}'/>
                <arg value='${org.apache.rat.scan.name.diff}'/>
                <arg value='@{host}'/>
                <arg path='@{src-dir}/org/apache/rat/scan/'/>
            </exec>
            <!--
            <exec executable="svn">
                <arg line="add ${org.apache.rat.scan.data.xml} ${org.apache.rat.scan.data.asc} ${org.apache.rat.scan.in}"/>
            </exec>
            -->
        </sequential>
    </macrodef>
</antlib>
